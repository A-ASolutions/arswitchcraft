<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8" />
<title>Ø³ÙˆÙŠØªØ´ ÙƒØ±Ø§ÙØª â€” Ø¥Ø´Ø¹Ø§Ù„ Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ø¥Ù„Ù‰ Ø§Ù„Ù…Ù‡Ù…Ø© Ù„Ø§Ø¶Ø·Ø±Ø§Ø¨ ÙØ±Ø· Ø§Ù„Ø­Ø±ÙƒØ© ÙˆØªØ´ØªØª Ø§Ù„Ø§Ù†ØªØ¨Ø§Ù‡</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<meta name="description" content="ØªÙ‡ÙŠØ¦Ø© Ø¬Ø³Ø¯ÙŠØ© Ù‡Ø§Ø¯Ø¦Ø©ØŒ ØªÙ†ÙÙ‘Ø³ØŒ Ø¥Ø±Ø®Ø§Ø¡ Ø§Ù„Ù†Ø¸Ø±ØŒ ØªØªØ¨Ù‘Ø¹ Ø¨ØµØ±ÙŠØ› Ø®Ø·ÙˆØ© ØµØºÙŠØ±Ø©Ø› Ù…ÙƒØ§ÙØ£Ø© Ù…Ø¤ÙƒØ¯Ø©Ø› ÙˆØªØ£Ù…Ù„ Ø±Ø­ÙŠÙ…. ÙŠØ¹Ù…Ù„ Ù…Ø­Ù„ÙŠÙ‹Ø§ Ø¹Ù„Ù‰ Ø¬Ù‡Ø§Ø²Ùƒ." />
<style>
  :root{
    --bg:#0f1115; --card:#161922; --muted:#8b92a7; --text:#e9edf7; --accent:#7cc4ff; --accent2:#9ef0c3;
    --shadow:0 10px 30px rgba(0,0,0,.35); --radius:16px;
  }
  *{box-sizing:border-box}
  body{margin:0; font:16px/1.6 system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial,"Noto Naskh Arabic","Amiri","Tahoma"; color:var(--text);
       background:radial-gradient(1200px 800px at 20% -10%, #1a1f2b 0, #0f1115 55%) fixed;}
  .wrap{max-width:980px; margin:24px auto 80px; padding:0 16px}
  header{display:flex; align-items:center; justify-content:space-between; gap:16px; margin-bottom:16px}
  h1{margin:0; font-size:28px}
  .tagline{color:var(--muted); font-size:14px}
  .card{background:linear-gradient(180deg,#171b25,#131722); border:1px solid #232835; border-radius:16px; box-shadow:var(--shadow); padding:20px; margin-top:16px}
  .stepper{display:flex; gap:8px; flex-wrap:wrap}
  .chip{padding:8px 12px; border-radius:999px; border:1px solid #2a3040; color:var(--muted)}
  .chip.active{border-color:var(--accent); color:var(--text); background:linear-gradient(180deg,#162436,#121826)}
  .grid{display:grid; gap:16px}
  @media(min-width:860px){ .grid.two{grid-template-columns:1.2fr .8fr} }
  label{display:block; color:var(--muted); font-size:13px; margin-bottom:6px}
  input[type=text],select,textarea{width:100%; background:#0f131c; border:1px solid #253046; color:var(--text); border-radius:12px; padding:12px 14px}
  input[type=checkbox]{transform:scale(1.15); margin-left:6px}
  .row{display:flex; gap:10px; flex-wrap:wrap; align-items:center}
  .btn{appearance:none; border:none; background:linear-gradient(180deg,#1b2a3d,#132033); color:#e9f6ff; padding:12px 16px; border-radius:12px; cursor:pointer; font-weight:600; border:1px solid #24324a; transition:transform .06s ease, filter .2s}
  .btn:hover{filter:brightness(1.05)} .btn:active{transform:translateY(1px)}
  .btn.primary{background:linear-gradient(180deg,#1f3b5a,#16314b); border-color:#2a4f77; box-shadow:0 6px 18px rgba(66,133,244,.18)}
  .btn.ghost{background:#0f131c; border-color:#223146; color:#cfe8ff}
  .btn.ok{background:linear-gradient(180deg,#1b3b2f,#142b23); border-color:#2e5a47; color:#dcffe4}
  .btn.warn{background:linear-gradient(180deg,#3b2a1b,#2b1f16); border-color:#5a4131; color:#ffe6c0}
  .btn.danger{background:linear-gradient(180deg,#3b1b22,#2b151a); border-color:#5a2e39; color:#ffd6dc}
  .pill{padding:8px 12px; border-radius:999px; background:#0f131c; border:1px solid #263149; color:#cfe1ff; font-size:13px}
  .muted{color:var(--muted)} .tiny{font-size:12px}
  .hr{height:1px; background:linear-gradient(90deg,transparent,#242a3a,transparent); margin:14px 0}
  progress{width:100%; height:12px; border:0; background:#0f131c; border-radius:999px; overflow:hidden}
  progress::-webkit-progress-value{background:linear-gradient(90deg,#7cc4ff,#9ef0c3)}
  .timer{font-variant-numeric:tabular-nums; font-size:40px; letter-spacing:1px; text-align:center; margin:6px 0 4px}
  .list{display:flex; flex-direction:column; gap:10px}
  .rowx{display:flex; justify-content:space-between; gap:10px; padding:10px; background:#0f131c; border:1px solid #222a3a; border-radius:12px}
  .badge{padding:4px 8px; border-radius:999px; font-size:12px; border:1px solid #2a3040; color:#b6c2e1}
  .inventory{display:flex; gap:10px; flex-wrap:wrap} .inv{background:#0f131c; border:1px solid #243046; border-radius:10px; padding:8px 10px; font-size:13px}
  .hidden{display:none !important}

  /* Wheel */
  .wheel-wrap{display:flex; flex-direction:column; align-items:center; gap:10px}
  .wheel{width:260px; height:260px; border-radius:50%; border:8px solid #0f131c; position:relative; overflow:hidden;
         box-shadow:0 10px 30px rgba(0,0,0,.35), inset 0 0 0 1px #2a3040; background:conic-gradient(#18243a 0 45deg,#1a2b3f 45deg 90deg,#18243a 90deg 135deg,#1a2b3f 135deg 180deg,#18243a 180deg 225deg,#1a2b3f 225deg 270deg,#18243a 270deg 315deg,#1a2b3f 315deg 360deg);
         transition:transform 3.2s cubic-bezier(.17,.67,.19,1.02)}
  .wheel .label{position:absolute; left:50%; top:50%; transform-origin:0 0; color:#cfe8ff; font-size:12px}
  .pointer{width:0; height:0; border-right:10px solid transparent; border-left:10px solid transparent; border-bottom:14px solid var(--accent); margin-top:6px}
  .spinning{opacity:.8; pointer-events:none}

  /* Ignite sub-screens */
  .ignite-tabs{display:flex; gap:8px; flex-wrap:wrap; margin-bottom:10px}
  .ignite-tab{padding:6px 10px; border-radius:999px; border:1px solid #2a3040; color:#b6c2e1; cursor:pointer}
  .ignite-tab.active{border-color:#7cc4ff; color:#eaf5ff; background:linear-gradient(180deg,#132035,#0f1828)}
  .ignite-view{min-height:240px; position:relative; overflow:hidden}

  /* Breath circle â€” smoother visual feedback */
  .breath-circle{
    width:160px; height:160px; border-radius:50%; margin:0 auto;
    background:radial-gradient(circle at 50% 50%, #1e3a5a, #0f1825);
    border:1px solid #2a3b55;
    box-shadow:inset 0 0 40px rgba(124,196,255,.15), 0 0 0 rgba(124,196,255,0);
    will-change: transform, box-shadow;
  }
  .breath-circle.breathe-glow{
    box-shadow: inset 0 0 40px rgba(124,196,255,.15), 0 8px 24px rgba(124,196,255,.18);
  }
  .breath-text{text-align:center; font-size:18px; margin-top:8px}

  /* Soft-eyes vignette */
  .vignette:before{content:""; position:absolute; inset:-20px; pointer-events:none;
                   background:radial-gradient(circle at 50% 50%, rgba(0,0,0,0) 45%, rgba(0,0,0,.35) 85%)}

  /* Eye movement */
  .track{position:relative; height:220px; border:1px dashed #28334a; border-radius:12px; background:#0f131c}
  .dot{position:absolute; width:16px; height:16px; border-radius:50%; background:#a8d6ff; box-shadow:0 0 8px rgba(124,196,255,.6)}

  /* Toast */
  .toast{
    position:fixed; left:50%; bottom:24px; transform:translateX(-50%) translateY(20px);
    background:#101826; border:1px solid #263149; color:#d9e7ff; padding:10px 14px; border-radius:10px;
    box-shadow:0 10px 30px rgba(0,0,0,.35); opacity:0; pointer-events:none; transition:opacity .2s, transform .2s;
    z-index:9999;
  }
  .toast.show{opacity:1; transform:translateX(-50%) translateY(0)}
  .toast.ok{border-color:#2e5a47}
  .toast.warn{border-color:#5a4131}
  .toast.info{border-color:#2a4f77}

  /* Credit line */
  .credit{
    margin: 18px 0 6px;
    text-align:center;
    font-size:12px;
    color: var(--muted);
  }
  .credit a{ color:#a8d6ff; text-decoration:none; border-bottom:1px dotted #2a3040 }
</style>
</head>
<body>
<div class="wrap">
  <header>
    <div>
      <h1>Ø³ÙˆÙŠØªØ´ ÙƒØ±Ø§ÙØª</h1>
      <div class="tagline">Ø£Ø¯Ø§Ø© Ù„Ø·ÙŠÙØ© Ù„Ø¥Ø´Ø¹Ø§Ù„ Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ø¥Ù„Ù‰ Ø§Ù„Ù…Ù‡Ù…Ø© â€¢ Ø®ØµÙˆØµÙŠØªÙƒ Ù…Ø­ÙÙˆØ¸Ø© Ø¹Ù„Ù‰ Ø¬Ù‡Ø§Ø²Ùƒ</div>
    </div>
    <div class="row">
      <label class="row tiny" style="gap:6px"><input id="soundToggle" type="checkbox" checked> ØµÙˆØª</label>
      <button class="btn ghost tiny" id="testSound" title="Ø¬Ø±Ù‘Ø¨ Ø§Ù„Ø¬Ø±Ø³">ØªØ¬Ø±Ø¨Ø© Ø§Ù„ØµÙˆØª</button>
      <label class="row tiny" style="gap:6px"><input id="gentleToggle" type="checkbox"> ÙˆØ¶Ø¹ Ù„Ø·ÙŠÙ</label>
    </div>
  </header>

  <div class="stepper">
    <div class="chip active" data-step-chip="1">Ù¡ Â· Ø§Ù„ØªØ®Ø·ÙŠØ·</div>
    <div class="chip" data-step-chip="2">Ù¢ Â· Ø§Ù„ØªÙ‡ÙŠØ¦Ø©</div>
    <div class="chip" data-step-chip="3">Ù£ Â· Ø®Ø·ÙˆØ© ØµØºÙŠØ±Ø©</div>
    <div class="chip" data-step-chip="4">Ù¤ Â· ÙØªØ±Ø© Ø§Ù„ØªØ±ÙƒÙŠØ²</div>
    <div class="chip" data-step-chip="5">Ù¥ Â· Ø§Ù„Ù…ÙƒØ§ÙØ£Ø© ÙˆØ§Ù„ØªØ£Ù…Ù„</div>
    <div class="chip" data-step-chip="6">Ù¦ Â· Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª ÙˆØ§Ù„Ù…ØªØ§Ø¨Ø¹Ø©</div>
  </div>

  <!-- STEP 1: PLAN -->
  <section class="card" data-step="1">
    <div class="grid two">
      <div>
        <label for="task">Ù…Ø§ Ø§Ù„Ù…Ù‡Ù…Ø© Ø§Ù„ØªØ§Ù„ÙŠØ©ØŸ</label>
        <input id="task" type="text" placeholder="Ù…Ø«Ù„Ø§Ù‹: Ø£ÙƒØªØ¨ ÙÙ‚Ø±ØªÙŠÙ† Ù…Ù† Ø§Ù„ØªÙ‚Ø±ÙŠØ±" />
        <label for="value" style="margin-top:10px">Ù„Ù…Ø§Ø°Ø§ ØªÙ‡Ù…ØŸ (Ù‚ÙŠÙ…Ø© Ø´Ø®ØµÙŠØ©)</label>
        <div class="row">
          <select id="value">
            <option>Ø§Ù„Ù…Ø¹Ù†Ù‰ ÙˆØ§Ù„Ø§ØªØ¬Ø§Ù‡</option><option>Ø§Ù„Ø¹Ø§Ø¦Ù„Ø©</option><option>Ø§Ù„ØµØ­Ø©</option>
            <option>Ø§Ù„ØªØ¹Ù„Ù‘Ù…</option><option>Ø§Ù„Ø¹Ù…Ù„ ÙˆØ§Ù„Ø£Ø«Ø±</option><option>Ø§Ù„Ø¥Ø¨Ø¯Ø§Ø¹</option><option>Ø§Ù„Ø¥ÙŠÙ…Ø§Ù†/Ø§Ù„Ù…Ø¹Ù†Ù‰</option>
          </select>
          <input id="customValue" type="text" placeholder="Ø£Ùˆ Ø§ÙƒØªØ¨ Ù‚ÙŠÙ…Ø© Ø®Ø§ØµØ© Ø¨Ùƒâ€¦" />
        </div>
        <div class="row" style="margin-top:12px">
          <button class="btn primary" id="beginIgnition">Ø§Ø¨Ø¯Ø£ Ø§Ù„ØªÙ‡ÙŠØ¦Ø©</button>
          <button class="btn ghost" id="skipIgnition">ØªØ®Ø·Ù‘Ù Ø¥Ù„Ù‰ Ø§Ù„Ø®Ø·ÙˆØ© Ø§Ù„ØµØºÙŠØ±Ø©</button>
        </div>
        <div class="hr"></div>
        <div class="tiny muted">Ø³Ù†Ù‚ØªØ±Ø­ <b>Ø®Ø·ÙˆØ© ØµØºÙŠØ±Ø©</b> ØªØ¨Ø¯Ø£ Ø¨Ù‡Ø§ Ø®Ù„Ø§Ù„ Ø¯Ù‚ÙŠÙ‚Ø© Ø£Ùˆ Ø¯Ù‚ÙŠÙ‚ØªÙŠÙ†.</div>
      </div>
      <div>
        <div class="inventory">
          <div class="inv">ğŸŸï¸ Ø§Ù„Ø¬ÙˆÙƒØ±: <span id="invJokers">0</span></div>
          <div class="inv">â­ Ø§Ù„Ù…Ù„ØµÙ‚Ø§Øª: <span id="invStickers">0</span></div>
          <div class="inv">ğŸª™ Ø§Ù„Ø¹Ù…Ù„Ø§Øª: <span id="invCoins">0</span></div>
        </div>
        <div class="hr"></div>
        <div class="list tiny">
          <div class="rowx"><div>Ø²Ù…Ù† Ø§Ù„ØªÙ‡ÙŠØ¦Ø© (Ù…ØªÙˆØ³Ø·)</div><div id="avgLatency">â€”</div></div>
          <div class="rowx"><div>Ø¯Ù‚Ø§Ø¦Ù‚ Ø§Ù„ØªØ±ÙƒÙŠØ² (Ù§ Ø£ÙŠØ§Ù…)</div><div id="focus7">â€”</div></div>
          <div class="rowx"><div>Ù…Ø±Ù‘Ø§Øª Ø§Ù„Ø¥Ù„ØºØ§Ø¡ Ø§Ù„ÙŠÙˆÙ…</div><div id="abandonsToday">0</div></div>
        </div>
      </div>
    </div>
  </section>

  <!-- STEP 2: IGNITE -->
  <section class="card hidden" data-step="2">
    <div class="row" style="justify-content:space-between">
      <div class="pill">ØªÙ‡ÙŠØ¦Ø© Ø¬Ø³Ø¯ÙŠØ© Ù‡Ø§Ø¯Ø¦Ø© Â· Ù£ Ø£Ø¬Ø²Ø§Ø¡</div>
      <div class="tiny muted">Ø§Ø¬Ù„Ø³ Ø£Ùˆ Ù‚Ù ÙƒÙ…Ø§ ØªØ±ØªØ§Ø­. Ø§Ù„Ù„Ø·ÙŠÙ ÙŠÙƒÙÙŠ.</div>
    </div>

    <div class="ignite-tabs">
      <div class="ignite-tab active" data-ig-tab="breath">Ù¡) Ø§Ù„ØªÙ†ÙÙ‘Ø³</div>
      <div class="ignite-tab" data-ig-tab="soft">Ù¢) Ø¥Ø±Ø®Ø§Ø¡ Ø§Ù„Ù†Ø¸Ø±</div>
      <div class="ignite-tab" data-ig-tab="eye">Ù£) Ø­Ø±ÙƒØ© Ø§Ù„Ø¹ÙŠÙ†</div>
    </div>

    <!-- Breath -->
    <div class="ignite-view" data-ig="breath">
      <div class="breath-circle" id="breathCircle"></div>
      <div class="breath-text" id="breathText">Ø¹Ù†Ø¯ Ø§Ù„Ø¨Ø¯Ø¡: Ø´Ù‡ÙŠÙ‚â€¦ Ø´Ù‡ÙŠÙ‚ Ù‚ØµÙŠØ± Ù…ÙƒÙ…Ù„â€¦ Ø²ÙÙŠØ± Ø·ÙˆÙŠÙ„. (Ù…Ø±Ù‘ØªØ§Ù†)</div>
      <div class="timer" id="breathTimer">00:00</div>
      <progress id="breathProg" max="100" value="0"></progress>
      <div class="row" style="margin-top:10px">
        <button class="btn primary" id="startBreath">Ø§Ø¨Ø¯Ø£</button>
        <button class="btn ghost" id="nextSoft1">Ø§Ù„ØªØ§Ù„ÙŠ: Ø¥Ø±Ø®Ø§Ø¡ Ø§Ù„Ù†Ø¸Ø±</button>
      </div>
      <div class="tiny muted" style="margin-top:8px">Ø§Ù„ØªÙ†ÙÙ‘Ø³ Ø§Ù„ÙØ³ÙŠÙˆÙ„ÙˆØ¬ÙŠ: Ø´Ù‡ÙŠÙ‚ ~Ù£ Ø«ÙˆØ§Ù†Ù â†’ Ø´Ù‡ÙŠÙ‚ Ù‚ØµÙŠØ± ~Ù Ù«Ù§ â†’ Ø²ÙÙŠØ± Ø·ÙˆÙŠÙ„ ~Ù¥â€“Ù¦ Ø«ÙˆØ§Ù†Ù.</div>
    </div>

    <!-- Soft eyes -->
    <div class="ignite-view hidden vignette" data-ig="soft">
      <div class="breath-text" style="margin-top:10px">Ø§Ø±Ø®Ù Ø§Ù„Ù†Ø¸Ø±Ø©. Ù„Ø§Ø­Ø¸ Ø£Ø·Ø±Ø§Ù Ù…Ø¬Ø§Ù„ Ø±Ø¤ÙŠØªÙƒ. Ø£Ø±Ø®Ù Ø§Ù„ÙÙƒ ÙˆØ§Ù„ÙƒØªÙÙŠÙ†.</div>
      <div class="timer" id="softTimer">00:00</div>
      <progress id="softProg" max="100" value="0"></progress>
      <div class="row" style="margin-top:10px">
        <button class="btn primary" id="startSoft">Ø§Ø¨Ø¯Ø£</button>
        <button class="btn ghost" id="nextEye1">Ø§Ù„ØªØ§Ù„ÙŠ: Ø­Ø±ÙƒØ© Ø§Ù„Ø¹ÙŠÙ†</button>
      </div>
      <div class="tiny muted" style="margin-top:8px">Ù†ÙˆØ³Ù‘Ø¹ Ø§Ù„Ù…Ø¬Ø§Ù„ Ø§Ù„Ø¨ØµØ±ÙŠ Ù„ØªÙ‡Ø¯Ø¦Ø© Ø§Ù„Ù…Ù†Ø¸ÙˆÙ…Ø© Ø§Ù„Ù…ØªÙŠÙ‚Ø¸Ø©.</div>
    </div>

    <!-- Eye movement -->
    <div class="ignite-view hidden" data-ig="eye">
      <div class="row tiny"><span class="pill">ØªØªØ¨Ù‘Ø¹ Ø³Ù„Ø³</span>
        <label class="row tiny"><input type="radio" name="emMode" value="pursuit" checked> ØªØªØ¨Ù‘Ø¹</label>
        <label class="row tiny"><input type="radio" name="emMode" value="saccade"> Ø­Ø±ÙƒØ§Øª Ø³Ø±ÙŠØ¹Ø©</label>
        <label class="row tiny">Ø§Ù„Ø³Ø±Ø¹Ø© <input id="emSpeed" type="range" min="1" max="10" value="6"></label>
      </div>
      <div class="track" id="emTrack"><div class="dot" id="emDot" style="right:10px; top:100px"></div></div>
      <div class="timer" id="eyeTimer">00:00</div>
      <progress id="eyeProg" max="100" value="0"></progress>
      <div class="row" style="margin-top:10px">
        <button class="btn primary" id="startEye">Ø§Ø¨Ø¯Ø£</button>
        <button class="btn ok" id="toTiny">Ø¥Ù„Ù‰ Ø§Ù„Ø®Ø·ÙˆØ© Ø§Ù„ØµØºÙŠØ±Ø©</button>
      </div>
      <div class="tiny muted" style="margin-top:8px">Ø§ØªØ¨Ø¹ Ø§Ù„Ù†Ù‚Ø·Ø© Ø¨Ø±Ø§Ø­Ø©. Ù„Ø§ Ø­Ø§Ø¬Ø© Ù„Ù„Ø¯Ù‚Ø©.</div>
    </div>
  </section>

  <!-- STEP 3: TINY START -->
  <section class="card hidden" data-step="3">
    <div class="pill">Ø§Ù„Ø®Ø·ÙˆØ© Ù£ Â· Ø®Ø·ÙˆØ© ØµØºÙŠØ±Ø©</div>
    <h3 style="margin:10px 0 6px">Ø¬Ø±Ù‘Ø¨ Ù‡Ø°Ù‡ Ø§Ù„Ø®Ø·ÙˆØ© Ø§Ù„Ø¨Ø³ÙŠØ·Ø© (ÙÙŠ Ø¯Ù‚ÙŠÙ‚Ø© Ø£Ùˆ Ø¯Ù‚ÙŠÙ‚ØªÙŠÙ†):</h3>
    <div id="tinySuggestion" class="card" style="background:#101520; border-color:#20273a"></div>
    <div class="row" style="margin-top:10px">
      <button class="btn ghost" id="anotherTiny">Ø§Ù‚ØªØ±Ø§Ø­ Ø¢Ø®Ø±</button>
      <button class="btn ok" id="didTiny">Ø£Ù†Ø¬Ø²Øª Ø§Ù„Ø®Ø·ÙˆØ© âœ”</button>
    </div>
    <div class="hr"></div>
    <div class="row">
      <div class="pill">Ø§Ø®ØªØ± ÙØªØ±Ø© Ø§Ù„ØªØ±ÙƒÙŠØ²:</div>
      <button class="btn" data-mins="5">Ù¥ Ø¯Ù‚Ø§Ø¦Ù‚</button>
      <button class="btn" data-mins="8">Ù¨ Ø¯Ù‚Ø§Ø¦Ù‚</button>
      <button class="btn" data-mins="12">Ù¡Ù¢ Ø¯Ù‚ÙŠÙ‚Ø©</button>
      <button class="btn ghost" id="useJoker" title="ØªØ±Ù‚ÙŠØ© Ø§Ù„Ø¯ÙˆØ±Ø§Ù† Ø§Ù„Ù‚Ø§Ø¯Ù…" disabled>Ø§Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø¬ÙˆÙƒØ± ğŸŸï¸</button>
    </div>
  </section>

  <!-- STEP 4: FOCUS BLOCK -->
  <section class="card hidden" data-step="4">
    <div class="row" style="justify-content:space-between">
      <div class="pill">ÙØªØ±Ø© Ø§Ù„ØªØ±ÙƒÙŠØ²</div>
      <div class="tiny muted">ÙÙƒ Ù…Ø³ØªØ±Ø®ÙŠ â€¢ ÙƒØªÙØ§Ù† Ù‡Ø§Ø¯Ø¦ØªØ§Ù† â€¢ Ø±Ù…Ø´ Ø¨Ù„Ø·Ù</div>
    </div>
    <div class="timer" id="focusTimer">00:00</div>
    <progress id="focusProgress" max="100" value="0"></progress>
    <div class="row" style="margin-top:10px">
      <button class="btn ok" id="finishEarly">Ø£Ù†Ù‡Ù Ø§Ù„Ø¢Ù†</button>
      <button class="btn warn" id="pauseFocus">Ø¥ÙŠÙ‚Ø§Ù Ù…Ø¤Ù‚Ù‘Øª</button>
      <button class="btn danger" id="abortFocus">Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©</button>
    </div>
  </section>

  <!-- STEP 5: REWARD & REFLECT -->
  <section class="card hidden" data-step="5">
    <div class="grid two">
      <div>
        <div class="pill">Ø¯ÙˆÙ‘Ø± Ø§Ù„Ø¹Ø¬Ù„Ø© (Ù…ÙƒØ§ÙØ£Ø© Ù…Ø¶Ù…ÙˆÙ†Ø©)</div>
        <div class="wheel-wrap" style="margin-top:10px">
          <div class="pointer" aria-hidden="true"></div>
          <div class="wheel" id="wheel" aria-label="Ø¹Ø¬Ù„Ø© Ø§Ù„Ù…ÙƒØ§ÙØ£Ø©"></div>
          <div id="wheelResult" class="tiny muted">Ø¬Ø§Ù‡Ø² Ù„Ù„Ø¯ÙˆØ±Ø§Ù†</div>
          <div class="row">
            <button class="btn primary" id="spinWheel">Ø¯ÙˆÙ‘Ø±</button>
            <button class="btn ghost" id="skipWheel">ØªØ¬Ø§ÙˆØ²</button>
          </div>
        </div>
        <div style="margin-top:10px">
          <div class="inventory tiny">
            <div class="inv">ğŸŸï¸ Ø§Ù„Ø¬ÙˆÙƒØ±: <span id="invJokers2">0</span></div>
            <div class="inv">â­ Ø§Ù„Ù…Ù„ØµÙ‚Ø§Øª: <span id="invStickers2">0</span></div>
            <div class="inv">ğŸª™ Ø§Ù„Ø¹Ù…Ù„Ø§Øª: <span id="invCoins2">0</span></div>
          </div>
        </div>
      </div>
      <div>
        <div class="pill">ØªØ£Ù…Ù„ Ø³Ø±ÙŠØ¹ (Ù¢Ù â€“Ù£Ù  Ø«Ø§Ù†ÙŠØ©)</div>
        <div class="list" style="margin-top:10px">
          <div><span class="tiny muted">Ø²Ù…Ù† Ø§Ù„ØªÙ‡ÙŠØ¦Ø©</span> Â· <span class="badge" id="latencyOut">â€”</span></div>
          <div>
            <label for="effort">Ø§Ù„Ø¬Ù‡Ø¯ Ø§Ù„ÙŠÙˆÙ…</label>
            <input id="effort" type="range" min="1" max="5" value="3" />
            <div class="tiny muted">Ù¡ = Ø¬Ù‡Ø¯ Ø¨Ø³ÙŠØ· Â· Ù¥ = Ø¨Ø£Ù‚ØµÙ‰ Ø·Ø§Ù‚Ø© Ù…Ù†Ø§Ø³Ø¨Ø©</div>
          </div>
          <div>
            <label for="mood">Ø§Ù„Ù…Ø²Ø§Ø¬ Ø§Ù„Ø¢Ù†</label>
            <input id="mood" type="range" min="1" max="5" value="3" />
            <div class="tiny muted">Ù¡ = Ù…Ù†Ø®ÙØ¶ Â· Ù¥ = Ù…Ø±ØªÙØ¹</div>
          </div>
          <div class="row"><input id="stuck" type="checkbox"><label for="stuck">ØªØ¹Ù„Ù‘Ù‚Øª/ØªØ´ØªÙ‘ØªÙ‘Ù</label></div>
          <div class="row">
            <button class="btn ok" id="saveSession">Ø§Ø­ÙØ¸ Ø§Ù„Ø¬Ù„Ø³Ø©</button>
            <button class="btn ghost" id="anotherBlock">Ø§Ø¨Ø¯Ø£ ÙØªØ±Ø© Ø£Ø®Ø±Ù‰</button>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- STEP 6: STATS -->
  <section class="card hidden" data-step="6">
    <div class="row" style="justify-content:space-between">
      <div class="pill">Ø§Ù„Ø¬Ù„Ø³Ø§Øª Ø§Ù„Ø£Ø®ÙŠØ±Ø©</div>
      <div class="row">
        <button class="btn ghost" id="exportData">ØªØµØ¯ÙŠØ± JSON</button>
        <button class="btn ghost" id="clearData">Ø­Ø°Ù Ø§Ù„ÙƒÙ„ (Ù…Ø­Ù„ÙŠÙ‹Ø§)</button>
      </div>
    </div>
    <div id="sessionList" class="list" style="margin-top:12px"></div>
    <div class="hr"></div>
    <div class="row"><button class="btn primary" id="newSession">Ø¨Ø¯Ø¡ Ø¬Ù„Ø³Ø© Ø¬Ø¯ÙŠØ¯Ø©</button></div>
    <div class="tiny muted">Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ØªØ¨Ù‚Ù‰ Ø¹Ù„Ù‰ Ø¬Ù‡Ø§Ø²Ùƒ ÙÙ‚Ø·.</div>
  </section>

  <div class="tiny muted" style="margin-top:16px">
    ØªÙ†Ø¨ÙŠÙ‡: Ø¥Ø°Ø§ ÙƒØ§Ù† Ù„Ø¯ÙŠÙƒ Ø£ÙŠ Ù…Ø´ÙƒÙ„Ø© ÙÙŠ Ø§Ù„ØªÙ†ÙÙ‘Ø³ Ø£Ùˆ Ø§Ù„Ø¹ÙŠÙ†ÙŠÙ† ÙØªØ¬Ù†Ù‘Ø¨ Ù‡Ø°Ù‡ Ø§Ù„ØªÙ…Ø§Ø±ÙŠÙ†. ÙŠÙ…ÙƒÙ†Ùƒ ÙƒØªÙ… Ø§Ù„ØµÙˆØª ÙÙŠ Ø£ÙŠ ÙˆÙ‚Øª. Ù„Ø§ ØªÙØ±Ø³Ù„ Ø£ÙŠ Ø¨ÙŠØ§Ù†Ø§Øª Ø®Ø§Ø±Ø¬ Ø¬Ù‡Ø§Ø²Ùƒ.
  </div>

  <!-- CREDIT LINE (kept in English as requested) -->
  <footer class="credit">
    Designed and Created by <a href="https://meaningfulpaththerapy.com" target="_blank" rel="noopener">
      Meaningful Path Therapy (Abdullah Al-Shoaibi)
    </a>
  </footer>
</div>

<!-- Toast -->
<div class="toast" id="toast"></div>

<script>
(function(){
  const el = id=>document.getElementById(id);
  const q = s=>document.querySelector(s);
  const qa = s=>Array.from(document.querySelectorAll(s));
  const nowIso = ()=> new Date().toISOString();
  const fmt = s=> new Date(s*1000).toISOString().substring(14,19);
  const todayKey = ()=> new Date().toISOString().slice(0,10);

  // ===== WebAudio for reliable sound =====
  let audioCtx=null, soundOn=true;
  function ensureAudio(){ if(!audioCtx){ const AC=window.AudioContext||window.webkitAudioContext; if(AC) audioCtx=new AC(); } if(audioCtx?.state==="suspended") audioCtx.resume(); }
  function tone(f=880,d=0.12,gain=0.16){ if(!soundOn||!audioCtx) return; const o=audioCtx.createOscillator(), g=audioCtx.createGain(); o.type='sine'; o.frequency.value=f; o.connect(g); g.connect(audioCtx.destination); const t=audioCtx.currentTime; g.gain.setValueAtTime(0.0001,t); g.gain.exponentialRampToValueAtTime(gain,t+0.01); g.gain.exponentialRampToValueAtTime(0.0001,t+d); o.start(t); o.stop(t+d+0.02); }
  function ding(){ tone(880,0.08,0.14); setTimeout(()=>tone(660,0.10,0.12), 90); }
  ['click','touchstart','keydown'].forEach(evt=>window.addEventListener(evt,()=>{ if(!audioCtx) ensureAudio(); }, {once:true, passive:true}));

  // ===== Toast helper =====
  function showToast(msg, type='info'){
    const t=el('toast'); t.textContent=msg; t.className='toast show '+type;
    setTimeout(()=>{ t.classList.remove('show'); }, 1600);
  }

  // ===== State =====
  const state = {
    currentStep:1,
    inv:{jokers:0, stickers:0, coins:0},
    rules:{abandonsTodayMap:{}, gentleDefault:false, nextBlockDefault:8, spinUpgrade:false},
    session:{when:null, task:"", value:"", activationLatencySec:null, tinyStart:"", focusSeconds:0, aborted:false, effort:3, mood:3, stuck:false, reward:"None"},
    focus:{seconds:0, duration:0, running:false, paused:false, timer:null},
    planStartTs:null, ignitionStartTs:null,
    spinning:false
  };
  let _sessions=[];

  // ===== Persistence =====
  function load(){
    try{
      Object.assign(state.inv, JSON.parse(localStorage.getItem('sc_inv')||'{}'));
      const r = JSON.parse(localStorage.getItem('sc_rules')||'{}');
      state.rules = Object.assign(state.rules, r||{});
      if(typeof state.rules.spinUpgrade!=='boolean') state.rules.spinUpgrade=false;
      _sessions = JSON.parse(localStorage.getItem('sc_sessions')||'[]');
    }catch(e){}
    updateInvUI(); updateKPIs();
    if(state.rules.gentleDefault){ el('gentleToggle').checked = true; }
  }
  const saveInv = ()=>localStorage.setItem('sc_inv', JSON.stringify(state.inv));
  const saveRules = ()=>localStorage.setItem('sc_rules', JSON.stringify(state.rules));

  // ===== Navigation =====
  function goStep(n){
    state.currentStep=n;
    qa('[data-step]').forEach(s=>s.classList.add('hidden'));
    qa('[data-step-chip]').forEach(c=>c.classList.remove('active'));
    q(`[data-step="${n}"]`).classList.remove('hidden');
    q(`[data-step-chip="${n}"]`).classList.add('active');
    if(n===6) renderSessions();
  }

  // ===== Plan =====
  el('beginIgnition').addEventListener('click', ()=>{
    ensureAudio(); soundOn = el('soundToggle').checked;
    if(!el('task').value.trim()) el('task').value = "Ù…Ù‡Ù…Ø© Ø³Ø±ÙŠØ¹Ø©";
    state.planStartTs = performance.now();
    goStep(2); showIgnite('breath');
  });
  el('skipIgnition').addEventListener('click', ()=>{ state.planStartTs = performance.now(); goTinyStart(); });

  // ===== Ignite tabs =====
  function showIgnite(which){
    qa('.ignite-tab').forEach(t=>t.classList.toggle('active', t.getAttribute('data-ig-tab')===which));
    qa('.ignite-view').forEach(v=>v.classList.toggle('hidden', v.getAttribute('data-ig')!==which));
  }
  qa('.ignite-tab').forEach(t=>t.addEventListener('click', ()=>showIgnite(t.getAttribute('data-ig-tab'))));
  el('nextSoft1').addEventListener('click', ()=>showIgnite('soft'));
  el('nextEye1').addEventListener('click', ()=>showIgnite('eye'));
  el('toTiny').addEventListener('click', ()=>goTinyStart());

  // ===== Breath animation & timing (2 physiological sighs) â€” smooth RAF =====
  let breathRAF = null, breathStartTS = 0, breathElapsedMs = 0, breathRunning = false;
  const BREATH_PROFILE = {
    normal: { inhale: 3.2, topup: 0.7, exhale: 5.6, pause: 0.8, settle: 2.0 },
    gentle: { inhale: 2.4, topup: 0.6, exhale: 4.8, pause: 0.6, settle: 1.6 }
  };
  const easeInOutSine = t => -(Math.cos(Math.PI * t) - 1) / 2;
  const clamp01 = x => Math.max(0, Math.min(1, x));
  const lerp = (a, b, t) => a + (b - a) * t;

  function breathPhaseAt(t, P) {
    const one = [
      { key: 'Ø´Ù‡ÙŠÙ‚', d: P.inhale },
      { key: 'Ø´Ù‡ÙŠÙ‚ Ù‚ØµÙŠØ±',  d: P.topup  },
      { key: 'Ø²ÙÙŠØ± Ø·ÙˆÙŠÙ„', d: P.exhale },
      { key: 'Ø³ÙƒÙˆÙ† Ù‚ØµÙŠØ±',  d: P.pause  },
    ];
    const timeline = [...one, ...one, { key: 'ØªÙ‡Ø¯Ø¦Ø©', d: P.settle }];
    const total = timeline.reduce((s, p) => s + p.d, 0);
    t = Math.min(t, total);

    let acc = 0, phase = timeline[0];
    for (let i = 0; i < timeline.length; i++) {
      if (t <= acc + timeline[i].d) { phase = timeline[i]; break; }
      acc += timeline[i].d;
    }
    const localT = clamp01((t - acc) / phase.d);

    const base = 0.95, maxInhale = 1.16, topUpPeak = 1.20, minExhale = 0.88, settleTo = 0.96;

    let scale = base;
    switch (phase.key) {
      case 'Ø´Ù‡ÙŠÙ‚':
        scale = lerp(base, maxInhale, easeInOutSine(localT)); break;
      case 'Ø´Ù‡ÙŠÙ‚ Ù‚ØµÙŠØ±':
        scale = lerp(maxInhale, topUpPeak, easeInOutSine(localT)); break;
      case 'Ø²ÙÙŠØ± Ø·ÙˆÙŠÙ„':
        scale = lerp(topUpPeak, minExhale, easeInOutSine(localT)); break;
      case 'Ø³ÙƒÙˆÙ† Ù‚ØµÙŠØ±':
        scale = lerp(minExhale, base, easeInOutSine(localT)); break;
      case 'ØªÙ‡Ø¯Ø¦Ø©':
        scale = lerp(base, settleTo, easeInOutSine(localT)); break;
    }
    return { scale, label: phase.key, total };
  }

  function startBreath(){
    const P = (el('gentleToggle').checked || (state.rules?.gentleDefault)) ? BREATH_PROFILE.gentle : BREATH_PROFILE.normal;

    el('breathProg').value = 0;
    el('breathTimer').textContent = '00:00';
    const circle = el('breathCircle');
    const text = el('breathText');
    text.textContent = 'Ø´Ù‡ÙŠÙ‚';
    state.ignitionStartTs = state.ignitionStartTs || performance.now();

    const totalSecs = (P.inhale + P.topup + P.exhale + P.pause) * 2 + P.settle;
    const totalMs = totalSecs * 1000;

    breathRunning = true;
    breathStartTS = performance.now();
    breathElapsedMs = 0;

    circle.classList.add('breathe-glow');

    let lastPhase = 'Ø´Ù‡ÙŠÙ‚';
    cancelAnimationFrame(breathRAF);
    function loop(now){
      if(!breathRunning) return;
      breathElapsedMs = now - breathStartTS;

      const tSec = breathElapsedMs / 1000;
      const { scale, label } = breathPhaseAt(tSec, P);

      circle.style.transform = `scale(${scale.toFixed(3)})`;
      const glow = Math.max(0, (scale - 0.95)) * 50;
      circle.style.boxShadow = `inset 0 0 40px rgba(124,196,255,.15), 0 8px 24px rgba(124,196,255,${(glow/100).toFixed(2)})`;

      if (label !== lastPhase){
        if (label !== 'ØªÙ‡Ø¯Ø¦Ø©') { ding(); }
        lastPhase = label;
      }
      el('breathText').textContent = label;
      el('breathTimer').textContent = new Date(Math.min(breathElapsedMs, totalMs)).toISOString().substring(14, 19);
      el('breathProg').value = Math.round((breathElapsedMs / totalMs) * 100);

      if (breathElapsedMs >= totalMs){
        breathRunning = false;
        circle.classList.remove('breathe-glow');
        el('breathText').textContent = 'Ø§ÙƒØªÙ…Ù„ Ø§Ù„ØªÙ†ÙÙ‘Ø³.';
        ding();
        return;
      }
      breathRAF = requestAnimationFrame(loop);
    }
    breathRAF = requestAnimationFrame(loop);
  }
  el('startBreath').addEventListener('click', ()=>{ ensureAudio(); startBreath(); });

  // ===== Soft-eyes timing =====
  let softInt=null, softElapsed=0, softTotal=20;
  function softSetGentle(){ softTotal = el('gentleToggle').checked || state.rules.gentleDefault ? 12 : 20; }
  function startSoft(){
    softSetGentle(); softElapsed=0; el('softProg').value=0; el('softTimer').textContent='00:00';
    clearInterval(softInt);
    const txt = q('[data-ig="soft"] .breath-text');
    const cues = [
      {t:0, msg:'ÙˆØ³Ù‘Ø¹ Ù…Ø¬Ø§Ù„ Ø§Ù„Ø±Ø¤ÙŠØ© Ø¥Ù„Ù‰ Ø§Ù„Ø£Ø·Ø±Ø§Ù.'},
      {t:6, msg:'Ø§Ø±Ø®Ù Ø§Ù„ÙÙƒØŒ Ø§Ø®ÙØ¶ Ø§Ù„ÙƒØªÙÙŠÙ†.'},
      {t:12, msg:'Ø§Ø¬Ø¹Ù„ Ø§Ù„Ù†Ø¸Ø±Ø© Ù„ÙŠÙ†Ø© Ø¨Ù„Ø§ Ù…Ø¬Ù‡ÙˆØ¯.'}
    ];
    softInt = setInterval(()=>{
      softElapsed++; el('softTimer').textContent = fmt(softElapsed);
      el('softProg').value = Math.round((softElapsed/softTotal)*100);
      const step = cues.reduce((a,b)=> b.t<=softElapsed ? b : a, cues[0]); txt.textContent = step.msg;
      if(softElapsed>=softTotal){ clearInterval(softInt); ding(); txt.textContent="ØªÙ…Ù‘ Ø¥Ø±Ø®Ø§Ø¡ Ø§Ù„Ù†Ø¸Ø±."; }
    }, 1000);
  }
  el('startSoft').addEventListener('click', ()=>{ ensureAudio(); startSoft(); });

  // ===== Eye movement (pursuit or saccades) =====
  let emRAF=null, emRunning=false, emStart=0, emElapsed=0, emTotal=15, emMode='pursuit';
  function eyeSetGentle(){ emTotal = el('gentleToggle').checked || state.rules.gentleDefault ? 10 : 15; }
  qa('input[name="emMode"]').forEach(r=>r.addEventListener('change', e=>{ emMode = e.target.value; }));
  function startEye(){
    eyeSetGentle(); emElapsed=0; el('eyeProg').value=0; el('eyeTimer').textContent='00:00';
    const track = el('emTrack'), dot = el('emDot');
    const speed = +el('emSpeed').value; // 1..10
    const width = track.clientWidth - 20; const rightMin=10, rightMax = rightMin + width;
    const midY = track.clientHeight/2 - 8;
    emRunning=true; emStart=performance.now();
    cancelAnimationFrame(emRAF);
    function loop(t){
      if(!emRunning) return;
      emElapsed = Math.floor((t - emStart)/1000);
      el('eyeTimer').textContent = fmt(emElapsed);
      el('eyeProg').value = Math.round((emElapsed/emTotal)*100);
      const ms = (t - emStart);
      let x;
      if(emMode==='pursuit'){
        const period = (11 - speed) * 400;
        const phase = (ms % period) / period;
        const s = Math.sin(phase * Math.PI*2) * 0.5 + 0.5;
        x = rightMin + s * (rightMax - rightMin);
      }else{ // saccades
        const stepMs = (11 - speed) * 90 + 110;
        const idx = Math.floor(ms/stepMs) % 6;
        const positions = [rightMin, rightMax, rightMin+(rightMax-rightMin)*0.35, rightMax, rightMin, rightMin+(rightMax-rightMin)*0.65];
        x = positions[idx];
      }
      dot.style.right = x+'px'; dot.style.top = (midY + Math.sin(ms/800)*20) + 'px';
      if(emElapsed>=emTotal){ emRunning=false; ding(); }
      else emRAF = requestAnimationFrame(loop);
    }
    emRAF = requestAnimationFrame(loop);
  }
  el('startEye').addEventListener('click', ()=>{ ensureAudio(); startEye(); });

  // ===== Tiny start =====
  const gentleTiny = [
    "Ø§ÙØªØ­ Ø§Ù„Ù…Ù„Ù/Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ ÙÙ‚Ø·. ØªÙˆÙ‚Ù‘Ù Ù‡Ù†Ø§. Ù„Ø§Ø­Ø¸ ØªÙ†ÙÙ‘Ø³Ùƒ.",
    "Ø§ÙƒØªØ¨ Ø¹Ù†ÙˆØ§Ù†Ù‹Ø§ Ù…Ø¤Ù‚ØªÙ‹Ø§ ÙÙ‚Ø·. Ø§Ø­ÙØ¸ ÙˆØ§Ù†ØªÙ‡Ù.",
    "Ø§ÙƒØªØ¨ Ù†Ù‚Ø·Ø© ÙˆØ§Ø­Ø¯Ø© ÙÙ‚Ø·.",
    "Ø§Ø¶Ø¨Ø· Ù…Ø¤Ù‚Ù‘Øª Ù£ Ø¯Ù‚Ø§Ø¦Ù‚ ÙˆØªØµÙÙ‘Ø­ Ø§Ù„ØµÙØ­Ø© Ø¨Ù‡Ø¯ÙˆØ¡.",
    "Ø¶Ø¹ Ø§Ù„Ù…Ø³ØªÙ†Ø¯ Ø£Ù…Ø§Ù…Ùƒ Ø«Ù… Ø§Ø¬Ù„Ø³. ÙÙ‚Ø·."
  ];
  const tinyBase = [
    "Ø§ÙØªØ­ Ù…Ø§ ØªØ­ØªØ§Ø¬Ù‡ Ù„Ù„Ù…Ù‡Ù…Ø© ÙÙ‚Ø· â€” ÙˆÙ„Ø§ Ø´ÙŠØ¡ ØºÙŠØ±Ù‡.",
    "Ø§ÙƒØªØ¨ Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ø£Ùˆ Ø£ÙˆÙ„ Ø¬Ù…Ù„Ø© ÙÙ‚Ø·.",
    "Ø§ÙƒØªØ¨ Ù£ Ù†Ù‚Ø§Ø· ØªÙÙØµÙ‘Ù„Ù‡Ø§ Ù„Ø§Ø­Ù‚Ù‹Ø§.",
    "Ø§Ø¶Ø¨Ø· Ù…Ø¤Ù‚Ù‘Øª Ù¥ Ø¯Ù‚Ø§Ø¦Ù‚ ÙˆØ§ÙƒØªØ¨ Ù…Ø§ Ø³ØªØ­ØªØ§Ø¬Ù‡ Ù…Ù† Ø£Ø¯ÙˆØ§Øª/Ù…ÙˆØ§Ø¯.",
    "Ø±ØªÙ‘Ø¨ Ø§Ù„Ø£Ø¯ÙˆØ§Øª Ø¹Ù„Ù‰ Ø§Ù„Ù…ÙƒØªØ¨ ÙˆØ§Ø¬Ù„Ø³.",
    "Ø£Ø±Ø³Ù„ Ø³Ø·Ø± Ù…ØªØ§Ø¨Ø¹Ø© ÙˆØ§Ø­Ø¯Ù‹Ø§ Ù„ÙŠØµØ¨Ø­ Ø§Ù„Ø£Ù…Ø± Ø­Ù‚ÙŠÙ‚ÙŠÙ‹Ø§.",
    "Ø§Ø±Ø³Ù… ØµÙ†Ø¯ÙˆÙ‚ Ù…Ø®Ø·Ø· ÙÙ‰ Ù¦Ù  Ø«Ø§Ù†ÙŠØ©.",
    "Ø³Ù…Ù‘Ù Ø¹Ø§Ø¦Ù‚Ù‹Ø§ ÙˆØ§Ø­Ø¯Ù‹Ø§ ÙˆØ®Ø·ÙˆØ© ØªØ§Ù„ÙŠØ© Ø³Ù‡Ù„Ø© Ø¬Ø¯Ù‹Ø§."
  ];
  function goTinyStart(){
    goStep(3);
    const useGentle = el('gentleToggle').checked || state.rules.gentleDefault || state.rules.nextBlockDefault===5;
    const pool = useGentle ? gentleTiny : tinyBase;
    const s = pool[Math.floor(Math.random()*pool.length)];
    el('tinySuggestion').textContent = s;
    state.session.tinyStart = s;
    el('useJoker').disabled = state.inv.jokers<=0;
  }
  el('anotherTiny').addEventListener('click', goTinyStart);
  el('didTiny').addEventListener('click', ()=>{ ding(); });

  // Focus block
  function startFocus(mins){
    state.session.when = nowIso();
    state.focus.duration = mins*60; state.focus.seconds=0; state.focus.running=true; state.focus.paused=false;
    const ref = state.ignitionStartTs || state.planStartTs || performance.now();
    state.session.activationLatencySec = Math.max(0, Math.round((performance.now()-ref)/1000));
    el('latencyOut').textContent = `${state.session.activationLatencySec}s`;
    el('focusTimer').textContent = fmt(state.focus.duration); el('focusProgress').value = 0;
    goStep(4);
    clearInterval(state.focus.timer);
    state.focus.timer = setInterval(()=>{
      if(!state.focus.running || state.focus.paused) return;
      state.focus.seconds++;
      const remain = Math.max(0, state.focus.duration - state.focus.seconds);
      el('focusTimer').textContent = fmt(remain);
      el('focusProgress').value = Math.round((state.focus.seconds/state.focus.duration)*100);
      if(remain<=0){ clearInterval(state.focus.timer); completeFocus(); }
    }, 1000);
  }
  qa('[data-mins]').forEach(b=>b.addEventListener('click', ()=>startFocus(+b.getAttribute('data-mins'))));
  function completeFocus(){ state.session.focusSeconds = state.focus.duration; state.session.aborted=false; ding(); goReward(); }
  function finishEarly(){ state.session.focusSeconds = Math.max(1, state.focus.seconds); state.session.aborted=false; clearInterval(state.focus.timer); ding(); goReward(); }
  function abortFocus(){
    state.session.focusSeconds = Math.max(0, state.focus.seconds); state.session.aborted=true; clearInterval(state.focus.timer);
    const tk=todayKey(); const m=state.rules.abandonsTodayMap||{}; m[tk]=(m[tk]||0)+1; state.rules.abandonsTodayMap=m;
    state.rules.nextBlockDefault=5; saveRules(); updateKPIs(); goReward(true);
  }
  el('finishEarly').addEventListener('click', finishEarly);
  el('pauseFocus').addEventListener('click', e=>{ state.focus.paused=!state.focus.paused; e.target.textContent = state.focus.paused ? "Ø§Ø³ØªØ¦Ù†Ø§Ù" : "Ø¥ÙŠÙ‚Ø§Ù Ù…Ø¤Ù‚Ù‘Øª"; });
  el('abortFocus').addEventListener('click', abortFocus);

  // ===== Reward wheel (ALWAYS rewards) =====
  const slices = [
    {label:"â­ Ù…Ù„ØµÙ‚", key:"sticker"},
    {label:"ğŸª™ Ø¹Ù…Ù„Ø©", key:"coin"},
    {label:"â­ Ù…Ù„ØµÙ‚", key:"sticker"},
    {label:"ğŸŸï¸ Ø¬ÙˆÙƒØ±", key:"joker"},
    {label:"â­ Ù…Ù„ØµÙ‚", key:"sticker"},
    {label:"ğŸª™ Ø¹Ù…Ù„Ø©", key:"coin"},
    {label:"â­ Ù…Ù„ØµÙ‚", key:"sticker"},
    {label:"ğŸª™ Ø¹Ù…Ù„Ø©", key:"coin"}
  ];
  const rewards = [
    {label:"â­ Ù…Ù„ØµÙ‚", gain:{stickers:1}, weight:44, key:"sticker"},
    {label:"ğŸª™ Ø¹Ù…Ù„Ø©",  gain:{coins:1},    weight:32, key:"coin"},
    {label:"ğŸŸï¸ Ø¬ÙˆÙƒØ±", gain:{jokers:1},   weight:24, key:"joker"}
  ];
  function buildWheel(){
    const w=el('wheel'); w.innerHTML="";
    for(let i=0;i<8;i++){
      const d=document.createElement('div'); d.className='label'; d.textContent=slices[i].label.split(' ')[0];
      const ang=i*45+22.5; d.style.transform=`rotate(${ang}deg) translate(85px) rotate(90deg)`; w.appendChild(d);
    }
    w.style.transition='none'; w.style.transform='rotate(0deg)'; void w.offsetWidth;
    w.style.transition='transform 3.2s cubic-bezier(.17,.67,.19,1.02)';
    el('wheelResult').textContent="Ø¬Ø§Ù‡Ø² Ù„Ù„Ø¯ÙˆØ±Ø§Ù†";
  }
  function weightedPick(){
    const total = rewards.reduce((a,b)=>a+b.weight,0);
    let r = Math.random()*total;
    for(const o of rewards){ r-=o.weight; if(r<=0) return o; }
    return rewards[0];
  }
  function sliceIndexForKey(key){
    const idxs=[]; slices.forEach((s,i)=>{ if(s.key===key) idxs.push(i); });
    return idxs[Math.floor(Math.random()*idxs.length)];
  }
  function goReward(fromAbort=false){
    goStep(5); buildWheel();
    el('wheelResult').textContent = fromAbort ? "ÙƒØ§Ù†Øª Ù…Ø­Ø§ÙˆÙ„Ø© ØµØ¹Ø¨Ø© â€” Ø­Ø§Ù† ÙˆÙ‚Øª Ù…ÙƒØ§ÙØ£Ø© Ø±Ø­ÙŠÙ…Ø©." : "Ø£Ø­Ø³Ù†Øª â€” Ù‡Ù„ ØªØ±ØºØ¨ Ø¨ØªØ¯ÙˆÙŠØ± Ø§Ù„Ø¹Ø¬Ù„Ø©ØŸ";
    el('invJokers2').textContent=state.inv.jokers; el('invStickers2').textContent=state.inv.stickers; el('invCoins2').textContent=state.inv.coins;
  }

  // Joker use (UPGRADES next spin: Stickerâ†’Coin, Coinâ†’Joker)
  el('useJoker').addEventListener('click', ()=>{
    if(state.inv.jokers<=0){
      showToast("Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¬ÙˆÙƒØ± Ù…ØªØ§Ø­.", 'warn');
      return;
    }
    state.inv.jokers--; saveInv(); updateInvUI();
    state.rules.spinUpgrade = true; saveRules();
    showToast("ØªÙ… Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø¬ÙˆÙƒØ±: Ø³ÙŠØªÙ… ØªØ±Ù‚ÙŠØ© Ø§Ù„Ø¯ÙˆØ±Ø§Ù† Ø§Ù„Ù‚Ø§Ø¯Ù… ğŸŸï¸", 'ok');
    el('useJoker').disabled = state.inv.jokers<=0;
    ding();
  });

  // Spin
  el('spinWheel').addEventListener('click', ()=>{
    if(state.spinning) return; ensureAudio(); state.spinning=true; el('spinWheel').classList.add('spinning');
    let outcome = weightedPick();

    // Apply Joker upgrade if set
    if(state.rules.spinUpgrade){
      if(outcome.key==='sticker'){ outcome = {label:"ğŸª™ Ø¹Ù…Ù„Ø©", gain:{coins:1}, key:"coin"}; }
      else if(outcome.key==='coin'){ outcome = {label:"ğŸŸï¸ Ø¬ÙˆÙƒØ±", gain:{jokers:1}, key:"joker"}; }
    }

    const idx = sliceIndexForKey(outcome.key);
    const sliceDeg = 360/8, centre = idx*sliceDeg + sliceDeg/2;
    const turns = 6 + Math.floor(Math.random()*3);
    const target = 360*turns + (360 - centre) + (Math.random()*6-3);
    const w=el('wheel');

    w.ontransitionend = ()=>{
      w.ontransitionend=null;
      el('wheelResult').textContent = `Ø§Ù„Ù†ØªÙŠØ¬Ø©: ${outcome.label}`;
      Object.entries(outcome.gain).forEach(([k,v])=> state.inv[k]+=v);
      saveInv(); updateInvUI(); ding();
      if(state.rules.spinUpgrade){ state.rules.spinUpgrade=false; saveRules(); showToast("ØªÙ… ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ØªØ±Ù‚ÙŠØ© âœ”ï¸", 'ok'); }
      state.spinning=false; el('spinWheel').classList.remove('spinning');
    };
    requestAnimationFrame(()=>{ w.style.transform=`rotate(${target}deg)`; });
  });
  el('skipWheel').addEventListener('click', ()=>{ el('wheelResult').textContent="ØªØ¬Ø§ÙˆØ²Øª Ø§Ù„Ø¯ÙˆØ±Ø§Ù†."; });

  // ===== Reflection & Stats =====
  function saveSession(){
    state.session.task = el('task').value.trim() || "Ù…Ù‡Ù…Ø© Ø³Ø±ÙŠØ¹Ø©";
    const cv = el('customValue').value.trim();
    state.session.value = cv || el('value').value;
    state.session.effort = +el('effort').value;
    state.session.mood = +el('mood').value;
    state.session.stuck = el('stuck').checked;
    _sessions.unshift({...state.session}); localStorage.setItem('sc_sessions', JSON.stringify(_sessions));
    updateKPIs(); resetForNew(); goStep(6);
  }
  function renderSessions(){
    const list=el('sessionList'); list.innerHTML="";
    if(!_sessions.length){ const d=document.createElement('div'); d.className='muted'; d.textContent="Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¬Ù„Ø³Ø§Øª Ø¨Ø¹Ø¯."; list.appendChild(d); return; }
    _sessions.slice(0,10).forEach(s=>{
      const row=document.createElement('div'); row.className='rowx';
      const left=document.createElement('div'); const dt=new Date(s.when||Date.now());
      left.innerHTML=`<div><b>${s.task||'Ù…Ù‡Ù…Ø© Ø¯ÙˆÙ† Ø¹Ù†ÙˆØ§Ù†'}</b></div><div class="tiny muted">${dt.toLocaleString()} Â· ${s.value||'-'} Â· Ø®Ø·ÙˆØ©: ${s.tinyStart||'-'}</div>`;
      const right=document.createElement('div'); right.style.textAlign='left';
      right.innerHTML=`<div class="badge">${s.activationLatencySec||0}s Ø²Ù…Ù† Ø§Ù„ØªÙ‡ÙŠØ¦Ø©</div>
                       <div class="tiny muted">${Math.round((s.focusSeconds||0)/60)} Ø¯ Â· ${s.aborted?'<span class="badge" style="border-color:#5a2e39;color:#ffd6dc">Ø£ÙÙ„ØºÙŠÙØª</span>':'<span class="badge" style="border-color:#2e5a47;color:#dcffe4">Ø§ÙƒØªÙ…Ù„Øª</span>'}</div>`;
      row.append(left,right); list.appendChild(row);
    });
  }
  function updateKPIs(){
    let lat=0,n=0, focus7=0; const weekAgo=Date.now()-7*864e5;
    for(const s of _sessions){ if(typeof s.activationLatencySec==='number'){ lat+=s.activationLatencySec; n++; } if(new Date(s.when).getTime()>=weekAgo){ focus7+=(s.focusSeconds||0); } }
    el('avgLatency').textContent = n? `${Math.round(lat/n)}s` : 'â€”';
    el('focus7').textContent = `${Math.round(focus7/60)} Ø¯`;
    const aband = (state.rules.abandonsTodayMap?.[todayKey()]||0); el('abandonsToday').textContent = aband;
  }
  function updateInvUI(){
    el('invJokers').textContent=state.inv.jokers; el('invStickers').textContent=state.inv.stickers; el('invCoins').textContent=state.inv.coins;
    el('invJokers2')&&(el('invJokers2').textContent=state.inv.jokers);
    el('invStickers2')&&(el('invStickers2').textContent=state.inv.stickers);
    el('invCoins2')&&(el('invCoins2').textContent=state.inv.coins);
  }
  function resetForNew(){
    state.planStartTs=null; state.ignitionStartTs=null; state.focus={seconds:0,duration:0,running:false,paused:false,timer:null};
    state.session={when:null, task:"", value:"", activationLatencySec:null, tinyStart:"", focusSeconds:0, aborted:false, effort:3, mood:3, stuck:false, reward:"None"};
  }

  // Reflection buttons
  el('saveSession').addEventListener('click', saveSession);
  el('anotherBlock').addEventListener('click', ()=>goTinyStart());

  // Export / Clear / New
  el('exportData').addEventListener('click', ()=>{
    const blob = new Blob([JSON.stringify({sessions:_sessions, inventory:state.inv, rules:state.rules}, null, 2)], {type:'application/json'});
    const url = URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download=`switchcraft_${todayKey()}.json`; a.click(); URL.revokeObjectURL(url);
  });
  el('clearData').addEventListener('click', ()=>{
    if(!confirm("Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù„Ù‘ÙŠØ© (Ø§Ù„Ø¬Ù„Ø³Ø§Øª ÙˆØ§Ù„Ù…Ø®Ø²ÙˆÙ† ÙˆØ§Ù„Ù‚ÙˆØ§Ø¹Ø¯)ØŸ")) return;
    localStorage.removeItem('sc_sessions'); localStorage.removeItem('sc_inv'); localStorage.removeItem('sc_rules');
    _sessions=[]; state.inv={jokers:0,stickers:0,coins:0}; state.rules={abandonsTodayMap:{}, gentleDefault:false, nextBlockDefault:8, spinUpgrade:false};
    updateInvUI(); updateKPIs(); renderSessions();
  });
  el('newSession').addEventListener('click', ()=>goStep(1));

  // Header toggles
  el('soundToggle').addEventListener('change', e=>{ soundOn=e.target.checked; if(soundOn) ensureAudio(); });
  el('testSound').addEventListener('click', ()=>{ ensureAudio(); ding(); });
  el('gentleToggle').addEventListener('change', e=>{ state.rules.gentleDefault = e.target.checked; saveRules(); });

  // Keyboard helpers
  window.addEventListener('keydown', e=>{
    if(state.currentStep===2 && e.key==='Enter'){ ensureAudio(); startBreath(); }
    if(state.currentStep===3 && e.key==='Enter'){ startFocus(state.rules.nextBlockDefault||8); }
    if(state.currentStep===4 && e.key==='Escape'){ abortFocus(); }
  });

  // Init
  load(); goStep(1);
})();
</script>
</body>
</html>
